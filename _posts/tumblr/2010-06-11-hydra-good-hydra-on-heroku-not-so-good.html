---
layout: post
title: Hydra - good, Hydra on Heroku - not so good
---

<p><a href="http://wiki.github.com/ngauthier/hydra/">Hydra</a> is a great tool for Rails development as it can distribute your tests to remote machines.  In my current project, we&#8217;re running  Ruby 1.9.1 on <a href="http://guides.rails.info/">Rails edge</a> with <a href="http://rubygems.org/gems/rspec/versions/2.0.0.beta.11">RSpec 2.0 beta</a> so not everything works right all the time.</p>

<p>The biggest culprit is having <a href="http://heroku.com/">Heroku</a> attempt to install our development and test gems.  In particular, if you list gem &#8216;hydra&#8217; within your Gemfile for Heroku - rake no longer works.  You get a helpful message like this:</p>

<pre><p>%  heroku rake routes --app your-app<br/>(in /disk1/home/slugs/192557_b2246d5_db92/mnt)<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:32: warning: already initialized constant RAKEVERSION<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake/alt_system.rb:32: warning: already initialized constant WINDOWS<br/>WARNING: Possible conflict with Rake extension: String#ext already exists<br/>WARNING: Possible conflict with Rake extension: String#pathmap already exists<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:404: warning: already initialized constant EMPTY_TASK_ARGS<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:452: warning: already initialized constant EMPTY<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:960: warning: already initialized constant RUBY_EXT<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:964: warning: already initialized constant RUBY<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1033: warning: already initialized constant LN_SUPPORTED<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1242: warning: already initialized constant ARRAY_METHODS<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1245: warning: already initialized constant MUST_DEFINE<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1249: warning: already initialized constant MUST_NOT_DEFINE<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1253: warning: already initialized constant SPECIAL_RETURN<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1259: warning: already initialized constant DELEGATING_METHODS<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1569: warning: already initialized constant DEFAULT_IGNORE_PATTERNS<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1575: warning: already initialized constant DEFAULT_IGNORE_PROCS<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1612: warning: already initialized constant FileList<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1638: warning: already initialized constant EARLY<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/.bundle/gems/gems/rake-0.8.7/lib/rake.rb:1968: warning: already initialized constant DEFAULT_RAKEFILES<br/>rake aborted!<br/>stack level too deep<br/>/disk1/home/slugs/192557_b2246d5_db92/mnt/Rakefile:10:in `&lt;top (required)&gt;'<br/>(See full trace by running task with --trace)<br/><br/><br/><br/></p></pre>

<p>So the fix is to exclude execution of the entire block by Heroku:</p>

<pre><p>source 'http://rubygems.org'<br/><br/>gem 'rails', '3.0.0.beta3'<br/><br/>## snip ##<br/><br/>if RUBY_PLATFORM =~ /darwin/<br/>  group :test do<br/>    gem 'rspec', '2.0.0.beta.11'<br/>    gem 'rspec-rails', '2.0.0.beta.11'<br/>    ## snip ##<br/>    gem 'hydra', :git =&gt; 'git://github.com/ngauthier/hydra.git'<br/>  end<br/>  <br/>  group :development, :test do<br/>    gem 'wirble'<br/>    gem 'hirb'<br/>    gem 'awesome_print'<br/>    gem 'ruby-debug19'      # does not support 1.9.2<br/>    gem 'ruby-debug-ide19'<br/>  end<br/>end</p></pre>

<p>If you run linux (as I do half the time), then check for this environment variable:</p>

<pre>if ENV[&#8220;SHELL&#8221;]&#160;!= &#8220;/usr/bin/git-shell&#8221;</pre>
